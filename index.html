<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª Ø¨Ø±Ùˆ 3D</title>
    <link rel="manifest" href="data:application/manifest+json,{"name":"SupermarketPro","short_name":"Market3D","start_url":".","display":"standalone","background_color":"#1a1a2e"}">
    <style>
        :root { --neon: #00ffaa; --bg: #0a0a12; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        #hud {
            position: absolute; top: 15px; right: 15px; width: 220px;
            background: rgba(10, 10, 20, 0.85); color: white; padding: 20px;
            border-radius: 15px; border-left: 4px solid var(--neon);
            backdrop-filter: blur(10px); z-index: 100;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .btn-order {
            width: 100%; background: var(--neon); color: #000; border: none;
            padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;
            transition: 0.3s;
        }
        .btn-order:active { transform: scale(0.95); }
        
        #controls-hint {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: #ccc; padding: 10px 20px;
            border-radius: 20px; font-size: 13px; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-row">ğŸ’° Ø§Ù„Ù…Ø§Ù„: <span id="money">500</span>$</div>
        <div class="stat-row">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†: <span id="inv">0</span></div>
        <div class="stat-row">ğŸ›’ Ù…Ø­Ù…ÙˆÙ„: <span id="held">0</span></div>
        <button class="btn-order" onclick="orderStock()">Ø·Ù„Ø¨ Ø¨Ø¶Ø§Ø¹Ø© (50$)</button>
    </div>

    <div id="controls-hint">Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ­Ø±Ùƒ | Space Ù„Ù„Ø­Ù…Ù„ ÙˆØ§Ù„ÙˆØ¶Ø¹ | ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª ğŸ“¶</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a12);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ---
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(hemiLight);
        const spotLight = new THREE.SpotLight(0xffffff, 1);
        spotLight.position.set(10, 20, 10);
        spotLight.castShadow = true;
        scene.add(spotLight);

        // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­Ù„ ---
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(30, 30),
            new THREE.MeshPhongMaterial({ color: 0x161625 })
        );
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ù„Ù…Ø¯ÙŠØ±)
        const player = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 1.6, 0.8),
            new THREE.MeshPhongMaterial({ color: 0x00ffaa })
        );
        player.position.y = 0.8;
        player.castShadow = true;
        scene.add(player);

        // Ø§Ù„Ø£Ø±ÙÙ
        const shelves = [];
        for(let i=0; i<3; i++) {
            const shelf = new THREE.Mesh(
                new THREE.BoxGeometry(4, 2, 1),
                new THREE.MeshPhongMaterial({ color: 0x303040 })
            );
            shelf.position.set(5, 1, i * 4 - 4);
            shelf.userData = { stock: 0 };
            scene.add(shelf);
            shelves.push(shelf);
        }

        // Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯
        const truckZone = new THREE.Mesh(new THREE.BoxGeometry(4, 0.1, 4), new THREE.MeshPhongMaterial({color: 0xffcc00}));
        truckZone.position.set(-8, 0.05, -8);
        scene.add(truckZone);

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Save/Load) ---
        let state = JSON.parse(localStorage.getItem('market_save')) || { money: 500, inv: 0, held: 0 };
        
        function saveGame() {
            localStorage.setItem('market_save', JSON.stringify(state));
            document.getElementById('money').innerText = Math.floor(state.money);
            document.getElementById('inv').innerText = state.inv;
            document.getElementById('held').innerText = state.held;
        }

        function orderStock() {
            if(state.money >= 50) {
                state.money -= 50;
                state.inv += 10;
                saveGame();
            }
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… ---
        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function update() {
            if(keys['ArrowUp']) player.position.z -= 0.12;
            if(keys['ArrowDown']) player.position.z += 0.12;
            if(keys['ArrowLeft']) player.position.x -= 0.12;
            if(keys['ArrowRight']) player.position.x += 0.12;

            // Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø®Ø²Ù†
            if(keys['Space'] && player.position.distanceTo(truckZone.position) < 2) {
                if(state.inv > 0 && state.held < 5) {
                    state.inv--; state.held++;
                    keys['Space'] = false; saveGame();
                }
            }

            // Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±ÙÙ
            shelves.forEach(s => {
                if(keys['Space'] && player.position.distanceTo(s.position) < 2) {
                    if(state.held > 0) {
                        state.held--;
                        state.money += 15; // Ø±Ø¨Ø­ Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ¨Ø³ÙŠØ·
                        saveGame();
                        keys['Space'] = false;
                    }
                }
            });

            camera.position.lerp(new THREE.Vector3(player.position.x, 10, player.position.z + 8), 0.1);
            camera.lookAt(player.position);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        saveGame(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø¹Ù…Ù„ Offline
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,self.addEventListener("fetch", (e) => e.respondWith(fetch(e.request)))');
        }
    </script>
</body>
</html>
